name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    # Using Ubuntu 20.04 for better binary compatibility with older systems (glibc 2.31)
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==6.17.0
        sudo apt-get update
        sudo apt-get install -y graphviz
    
    - name: Install package dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Build Linux executable with PyInstaller
      run: |
        # Create the executable with bundled configs and icons
        pyinstaller --onefile \
          --add-data "terravisualizer.hcl:." \
          --add-data "terravisualizer.json:." \
          --add-data "icons:icons" \
          --name terravisualizer \
          terravisualizer/cli.py
        
        # Move to bin directory structure
        mkdir -p dist/bin
        mv dist/terravisualizer dist/bin/terravisualizer
        chmod +x dist/bin/terravisualizer
    
    - name: Create release notes
      run: |
        cat > release_notes.md << EOF
        # Terravisualizer ${{ steps.get_version.outputs.VERSION }}
        
        ## Installation
        
        ### Option 1: Docker (Recommended)
        
        Run directly with Docker (no installation required):
        \`\`\`bash
        docker run --rm -v \$(pwd):/data ghcr.io/masluse/terravisualizer:${{ steps.get_version.outputs.VERSION }} --file tfplan.json
        \`\`\`
        
        Or use the latest version:
        \`\`\`bash
        docker run --rm -v \$(pwd):/data ghcr.io/masluse/terravisualizer:latest --file tfplan.json
        \`\`\`
        
        The Docker image includes all dependencies (Graphviz) and works on any platform.
        
        ### Option 2: Download and run the executable
        \`\`\`bash
        curl -sSL -o terravisualizer https://github.com/masluse/terravisualizer/releases/download/v${{ steps.get_version.outputs.VERSION }}/terravisualizer
        chmod +x terravisualizer
        ./terravisualizer --file tfplan.json
        \`\`\`
        
        The executable includes a default configuration, so you can run it without providing a config file.
        
        **Note**: While the executable is standalone and doesn't require Python, you still need to have Graphviz installed on your system.
        
        ## Prerequisites
        
        ### For Docker
        - Docker installed on your system
        
        ### For Standalone Executable
        - Graphviz (system package)
          - Ubuntu/Debian: \`sudo apt-get install graphviz\`
          - macOS: \`brew install graphviz\`
          - Windows: Download from https://graphviz.org/download/
        
        ## Usage
        
        ### Docker Usage
        
        Basic usage:
        \`\`\`bash
        docker run --rm -v \$(pwd):/data ghcr.io/masluse/terravisualizer:latest --file tfplan.json
        \`\`\`
        
        With custom configuration:
        \`\`\`bash
        docker run --rm -v \$(pwd):/data ghcr.io/masluse/terravisualizer:latest \\
          --file tfplan.json \\
          --config my_config.hcl \\
          --output diagram.png
        \`\`\`
        
        Different output format:
        \`\`\`bash
        docker run --rm -v \$(pwd):/data ghcr.io/masluse/terravisualizer:latest \\
          --file tfplan.json \\
          --output diagram.svg \\
          --format svg
        \`\`\`
        
        ### Standalone Executable Usage
        
        Basic usage with embedded default config:
        \`\`\`bash
        ./terravisualizer --file tfplan.json
        \`\`\`
        
        With custom configuration:
        \`\`\`bash
        ./terravisualizer --file tfplan.json --config my_config.hcl --output diagram.png
        \`\`\`
        
        ## What's New
        
        - ðŸ³ **Docker container available** - Run with all dependencies included
        - Linux executable with embedded default configuration
        - No Python installation required (standalone binary)
        - Includes icons for common resource types
        - Hierarchical resource grouping
        - Support for HCL and JSON configuration formats
        - Multiple output formats (PNG, SVG, PDF)
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/bin/terravisualizer
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max
